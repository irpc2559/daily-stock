<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>บันทึกการผลิต</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
:root{
  --bg:#ffffff;
  --text:#111;
  --muted:#999;
  --border:#e5e5e5;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.app{
  max-width:420px;
  margin:auto;
  padding:24px;
}
h1{
  font-size:22px;
  margin-bottom:24px;
}
.step{display:none}
.step.active{display:block}

.label{
  font-size:14px;
  color:var(--muted);
  margin-bottom:6px;
}
select,input{
  width:100%;
  height:48px;
  border:1px solid var(--border);
  border-radius:12px;
  font-size:18px;
  padding:0 14px;
}
.big-number{
  font-size:40px;
  text-align:center;
  margin:24px 0;
}
.keypad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}
.keypad button{
  height:64px;
  border-radius:50%;
  border:1px solid var(--border);
  background:#fff;
  font-size:22px;
}
.keypad .zero{grid-column:span 2;border-radius:32px}

.btn{
  width:100%;
  height:52px;
  border-radius:14px;
  border:none;
  margin-top:24px;
  font-size:18px;
}
.btn-primary{
  background:#000;
  color:#fff;
}
.btn-secondary{
  background:#fff;
  border:1px solid var(--border);
}
.center{text-align:center}
.success{
  font-size:22px;
  margin-bottom:12px;
}
</style>
</head>

<body>
<div class="app">

  <!-- STEP 1 -->
  <div class="step active" id="step1">
    <h1>เลือกสถานที่ขาย</h1>
    <div class="label">สถานที่</div>
    <select id="location">
      <option value="">-- เลือก --</option>
      <option value="LOC001">สาขา 1</option>
      <option value="LOC002">สาขา 2</option>
    </select>
    <button class="btn btn-primary" onclick="nextStep()">ถัดไป</button>
  </div>

  <!-- STEP 2 -->
  <div class="step" id="step2">
    <h1>ค่าเช่า</h1>
    <div class="big-number" id="rentDisplay">0</div>
    <div class="keypad">
      <button onclick="press(1)">1</button>
      <button onclick="press(2)">2</button>
      <button onclick="press(3)">3</button>
      <button onclick="press(4)">4</button>
      <button onclick="press(5)">5</button>
      <button onclick="press(6)">6</button>
      <button onclick="press(7)">7</button>
      <button onclick="press(8)">8</button>
      <button onclick="press(9)">9</button>
      <button class="zero" onclick="press(0)">0</button>
      <button onclick="back()">⌫</button>
    </div>
    <button class="btn btn-primary" onclick="nextStep()">ถัดไป</button>
  </div>

  <!-- STEP 3 -->
  <div class="step" id="step3">
    <h1 id="productTitle"></h1>
    <div class="label">จำนวนที่ผลิต</div>
    <input type="number" id="produceInput" min="0" />
    <button class="btn btn-primary" id="productBtn" onclick="nextProduct()">ถัดไป</button>
  </div>

  <!-- STEP 4 -->
  <div class="step center" id="step4">
    <div class="success">✅ บันทึกข้อมูลสำเร็จ</div>
    <button class="btn btn-primary" onclick="closeApp()">ออกจากหน้านี้</button>
  </div>

</div>

<script>
const LIFF_ID = "2008883092-lVX4JEfG";
const FLOW_URL = "https://defaulteda31a319b9748a88bd8d0897333bb.db.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/eb3f76bcbf41490cb0eb67e3f4478457/triggers/manual/paths/invoke?api-version=1";

const steps = document.querySelectorAll(".step");
let stepIndex = 0;

const data = {
  location:"",
  rent:0,
  items:[
    {id:"P01", name:"สินค้า A", produce:0},
    {id:"P02", name:"สินค้า B", produce:0}
  ]
};

let rentValue="";
let productIndex=0;

function showStep(i){
  steps.forEach(s=>s.classList.remove("active"));
  steps[i].classList.add("active");
}

function nextStep(){
  if(stepIndex===0){
    data.location = location.value;
    if(!data.location) return alert("เลือกสถานที่");
  }
  if(stepIndex===1){
    data.rent = Number(rentValue);
    if(data.rent<=0) return alert("กรอกค่าเช่า");
    loadProduct();
  }
  stepIndex++;
  showStep(stepIndex);
}

function press(n){
  rentValue+=n;
  rentDisplay.innerText = rentValue;
}
function back(){
  rentValue=rentValue.slice(0,-1);
  rentDisplay.innerText = rentValue || "0";
}

function loadProduct(){
  productTitle.innerText = data.items[productIndex].name;
}

function nextProduct(){
  data.items[productIndex].produce = Number(produceInput.value||0);
  produceInput.value="";
  productIndex++;

  if(productIndex < data.items.length){
    loadProduct();
    if(productIndex === data.items.length-1){
      productBtn.innerText="เสร็จสิ้น";
    }
  }else{
    submitData();
  }
}

async function submitData(){
  await fetch(FLOW_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  });
  stepIndex=3;
  showStep(stepIndex);
}

function closeApp(){
  liff.closeWindow();
}

(async()=>{
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) liff.login();
})();
</script>
</body>
</html>
