<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>บันทึกการผลิต</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#fff;
}
.app{
  max-width:420px;
  margin:auto;
  padding:24px;
}
h1{font-size:22px;margin-bottom:24px}
.step{display:none}
.step.active{display:block}

.option{
  border:1px solid #ddd;
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
  font-size:18px;
}
.option.active{
  background:#000;
  color:#fff;
}

.big-number{
  text-align:center;
  font-size:40px;
  margin:20px 0;
}

.keypad{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}
.keypad button{
  height:64px;
  border-radius:50%;
  border:1px solid #ddd;
  background:#fff;
  font-size:22px;
}

.btn{
  width:100%;
  height:52px;
  border-radius:14px;
  border:none;
  margin-top:24px;
  font-size:18px;
  background:#000;
  color:#fff;
}
.btn[disabled]{opacity:.4}
.center{text-align:center}
</style>
</head>

<body>
<div class="app">

<!-- STEP 1 -->
<div class="step active">
  <h1>เลือกสถานที่ขาย</h1>
  <div class="option" onclick="selectLocation('LOC001',this)">สาขา 1</div>
  <div class="option" onclick="selectLocation('LOC002',this)">สาขา 2</div>
  <button class="btn" id="btnStep1" disabled onclick="nextStep()">ถัดไป</button>
</div>

<!-- STEP 2 -->
<div class="step">
  <h1>ค่าเช่า</h1>
  <div class="big-number" id="rentDisplay">0</div>

  <div class="keypad">
    <button onclick="press(1)">1</button>
    <button onclick="press(2)">2</button>
    <button onclick="press(3)">3</button>
    <button onclick="press(4)">4</button>
    <button onclick="press(5)">5</button>
    <button onclick="press(6)">6</button>
    <button onclick="press(7)">7</button>
    <button onclick="press(8)">8</button>
    <button onclick="press(9)">9</button>
    <button style="grid-column:span 2" onclick="press(0)">0</button>
    <button onclick="back()">⌫</button>
  </div>

  <button class="btn" onclick="saveRent()">ถัดไป</button>
</div>

<!-- STEP 3 -->
<div class="step">
  <h1 id="productTitle"></h1>
  <div class="big-number" id="produceDisplay">0</div>

  <div class="keypad">
    <button onclick="pressProduce(1)">1</button>
    <button onclick="pressProduce(2)">2</button>
    <button onclick="pressProduce(3)">3</button>
    <button onclick="pressProduce(4)">4</button>
    <button onclick="pressProduce(5)">5</button>
    <button onclick="pressProduce(6)">6</button>
    <button onclick="pressProduce(7)">7</button>
    <button onclick="pressProduce(8)">8</button>
    <button onclick="pressProduce(9)">9</button>
    <button style="grid-column:span 2" onclick="pressProduce(0)">0</button>
    <button onclick="backProduce()">⌫</button>
  </div>

  <button class="btn" id="productBtn" onclick="nextProduct()">ถัดไป</button>
</div>

<!-- STEP 4 -->
<div class="step center">
  <h1>✅ บันทึกสำเร็จ</h1>
  <button class="btn" onclick="liff.closeWindow()">ออกจากหน้านี้</button>
</div>

</div>

<script>
const LIFF_ID = "2008883092-lVX4JEfG";
const FLOW_URL = "https://defaulteda31a319b9748a88bd8d0897333bb.db.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/eb3f76bcbf41490cb0eb67e3f4478457/triggers/manual/paths/invoke?api-version=1";

const steps = document.querySelectorAll(".step");
let stepIndex = 0;
let rentValue = "";
let produceValue = "";
let productIndex = 0;

const data = {
  location:"",
  rent:0,
  items: Array.from({length:10}, (_,i)=>({
    id:`P${i+1}`,
    name:`สินค้า ${i+1}`,
    produce:0
  }))
};

function showStep(i){
  steps.forEach(s=>s.classList.remove("active"));
  steps[i].classList.add("active");
}

function selectLocation(val,el){
  document.querySelectorAll(".option").forEach(o=>o.classList.remove("active"));
  el.classList.add("active");
  data.location = val;
  btnStep1.disabled = false;
}

function nextStep(){
  stepIndex++;
  showStep(stepIndex);
}

/* RENT */
function press(n){
  rentValue += n;
  rentDisplay.innerText = rentValue;
}
function back(){
  rentValue = rentValue.slice(0,-1);
  rentDisplay.innerText = rentValue || "0";
}
function saveRent(){
  data.rent = Number(rentValue||0);
  loadProduct();
  nextStep();
}

/* PRODUCT */
function loadProduct(){
  productTitle.innerText = data.items[productIndex].name;
  productBtn.innerText =
    productIndex === data.items.length-1 ? "เสร็จสิ้น" : "ถัดไป";
  produceValue="";
  produceDisplay.innerText="0";
}
function pressProduce(n){
  produceValue += n;
  produceDisplay.innerText = produceValue;
}
function backProduce(){
  produceValue = produceValue.slice(0,-1);
  produceDisplay.innerText = produceValue || "0";
}
function nextProduct(){
  data.items[productIndex].produce = Number(produceValue||0);
  productIndex++;
  if(productIndex < data.items.length){
    loadProduct();
  }else{
    submitData();
  }
}

async function submitData(){
  await fetch(FLOW_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  });
  stepIndex=3;
  showStep(stepIndex);
}

(async()=>{
  await liff.init({liffId:LIFF_ID});
  if(!liff.isLoggedIn()) liff.login();
})();
</script>
</body>
</html>
